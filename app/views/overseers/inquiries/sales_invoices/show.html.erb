<% content_for :heading do %>
  View Sales Invoice <%= @sales_invoice.to_s %>
<% end %>
<div class="col-12">
  <%= render layout: 'overseers/inquiries/tabs_layout' do %>
    <div class="card">
      <div class="card-header">
        <div class=form-row>
          <div class="col-6 col-md-1 mt-1 mt-md-0">
            <strong class="d-block">Quotation #</strong>
            <%=@inquiry.inquiry_number %>
          </div>
          <div class="col-6 col-md-3 mt-1 mt-md-0">
            <strong class="d-block">Customer Inquiry Reference</strong>
            <%= [@inquiry.inquiry_number, @inquiry.subject].join(" - ") %>
          </div>
          <div class="col-6 col-md-3 mt-1 mt-md-0">
            <strong class="d-block">Customer Purchase Order # </strong>
            <%= @inquiry.customer_po_number if @inquiry.customer_po_number.present? %>
          </div>
          <div class="col-6 col-md-3 mt-2  mt-md-0">
            <strong class="d-block">Customer Purchase Order Date </strong>
            <%= @inquiry.customer_order_date.strftime("%d-%b-%Y") if @inquiry.customer_order_date.present? %>
          </div>

          <div class="col-6 col-md-2 mt-2 mt-md-0 text-right">
            <% if policy(@sales_invoice).show? %>
                <%= row_action_button(overseers_inquiry_sales_invoice_path(@inquiry, @sales_invoice, format: :pdf), 'none', 'Download', 'success', :_blank, 'get', false, 'O') %>
                <%= row_action_button(duplicate_overseers_inquiry_sales_invoice_path(@inquiry, @sales_invoice, format: :pdf), 'none', 'Download', 'success', :_blank, 'get', false, 'D') %>
                <%= row_action_button(triplicate_overseers_inquiry_sales_invoice_path(@inquiry, @sales_invoice, format: :pdf), 'none', 'Download', 'success', :_blank, 'get', false, 'T') %>
                <%= row_action_button(make_zip_overseers_inquiry_sales_invoice_path(@inquiry, @sales_invoice, format: :zip), 'file-archive', 'Download zip', 'info', :_blank) %>

            <% end %>
          </div>
        </div>
      </div>
      <div class="card-body">
        <div class="form-row mb-1">
          <div class="col-12 col-md-2 mt-1 mt-md-0">
            <strong class="d-block">Sales Order #  </strong>
            <%= @sales_invoice.sales_order_id %>
          </div>
          <div class="col-6 col-md-2 mt-1 mt-md-0">
            <strong class="d-block">Sales Order Date</strong>
            <%= @sales_invoice.sales_order.mis_date.strftime("%d-%b-%Y") if @sales_invoice.sales_order.mis_date.present? %>
          </div>
          <div class="col-6 col-md-2 mt-1 mt-md-0">
            <strong class="d-block">Invoice #</strong>
            <%= @sales_invoice.metadata['increment_id'] %>
          </div>
          <div class="col-6 col-md-2 mt-1 mt-md-0">
            <strong class="d-block">Invoice Dates</strong>
            <%= @sales_invoice.mis_date %>

          </div>
          <div class="col-6 col-md-2 mt-1 mt-md-0">
            <strong class="d-block">GRN # </strong>

          </div>
          <div class="col-6 col-md-2 mt-1 mt-md-0">
            <strong class="d-block">Payment Terms</strong>
            <%= @inquiry.payment_option %>
          </div>
        </div>

        <div class="card-alternative mt-3">
          <div class="form-row">
            <div class="col-md-6 mt-2 mt-md-0">
              <strong class="d-block">Supplier - Bill from:</strong>
              <%= @inquiry.bill_from.address.name.to_s %><br>
              <%= @inquiry.bill_from.address.to_compact_multiline_s if @inquiry.bill_from.present? %><br>
              <% if @inquiry.bill_from.address.phone.present? %>
                <em>Contact</em>: <%= @inquiry.contact.full_name %> - <%= @inquiry.bill_from.address.phone %><br>
              <% end %>
              <% if @inquiry.bill_from.address.gst %>
                <em>GST Number</em>: <%= @inquiry.bill_from.address.gst %><br>
              <% end %>
            </div>
            <div class="col-md-6 mt-2 mt-md-0">
              <strong class="d-block">Supplier - Ship from:</strong>
              <%= @inquiry.ship_from.address.name.to_s %><br>
              <%= @inquiry.ship_from.address.to_compact_multiline_s if @inquiry.ship_from.present? %><br>
              <% if @inquiry.ship_from.address.mobile || @inquiry.ship_from.address.telephone %>
                <em>Contact</em>: <%= @inquiry.ship_from.address.mobile || @inquiry.ship_from.address.telephone %><br>
              <% end %>
              <% if @inquiry.ship_from.address.gst %>
                <em>GST Number</em>: <%= @inquiry.ship_from.address.gst %><br>
              <% end %>
            </div>
          </div>

          <div class="form-row mt-0 mt-md-2">
            <div class="col-md-6 mt-2 mt-md-0">
              <strong class="d-block">Customer - Bill to:</strong>
              <%= @inquiry.contact.full_name %><br>
              <%= @inquiry.billing_address.name %><br>
              <%= @inquiry.billing_address.to_multiline_s if @inquiry.billing_address.present? %>
              <br>
              <% if @sales_invoice.sales_order.inquiry.billing_contact.present? %>
                Tel: <%= @sales_invoice.sales_order.inquiry.billing_contact.phone || @sales_invoice.sales_order.inquiry.billing_contact.mobile || @inquiry.billing_address.telephone %>
              <% else %>
                Tel: <%= @sales_invoice.sales_order.inquiry.contact.phone || @sales_invoice.sales_order.inquiry.contact.mobile || @inquiry.billing_address.telephone %>
              <% end %> <br>
              <em>Email</em>: <%= @inquiry.contact.email if @inquiry.contact.email.present? %><br>
              GST No.:<%= @inquiry.billing_address.gst %><br>
            </div>
            <div class="col-md-6 mt-2 mt-md-0">
              <strong class="d-block">Customer - Ship to:</strong>
              <%= (@inquiry.shipping_company.name) %>
              <br>
              <%= @inquiry.shipping_address.name if @inquiry.shipping_address.present? %><br>
              <%= @inquiry.shipping_address.to_multiline_s if @inquiry.shipping_address.present? %>
              <br>
              <% if @inquiry.contact.mobile || @inquiry.contact.telephone %>
            <span class="d-block"><em>Contact</em>: <%= @inquiry.contact.full_name %>
              - <%= @inquiry.contact.phone %></span>
              <% end %>
              <em>Email</em>: <%= @inquiry.contact.email if @inquiry.contact.email.present? %>
              <span class="d-block"><em>GST Number</em>: <%= @inquiry.billing_address.gst || @inquiry.company.default_shipping_address.gst %></span>
            </div>
          </div>
        </div>

        <% if @inquiry.attachments.present? %>
          <div class="form-row mt-3">
            <div class="col-6">
              <strong class="d-block">Customer Purchase Order</strong>
              <%= link_to @inquiry.customer_po_sheet, target: '_blank' do %>
                <%= @inquiry.customer_po_sheet.filename %>
              <% end if @inquiry.customer_po_sheet.attached? %>
            </div>
            <div class="col-6">
              <% if @inquiry.copy_of_email.attached? %>
                <strong class="d-block">Email attachment</strong>
                <%= link_to @inquiry.copy_of_email, target: '_blank' do %>
                  <%= @inquiry.copy_of_email.filename %>
                <% end %>
              <% end %>
            </div>
            <div class="col-6 mt-2">
              <strong class="d-block">Supplier Quotes Attachment</strong>
              <% @inquiry.supplier_quotes.attachments.each do |attachment| %>
                <%= link_to url_for(attachment), target: '_blank', :status => attachment.filename do %>
                  <span class="d-block"><%= attachment.filename %></span>
                <% end %>
              <% end if @inquiry.supplier_quotes.attached? %>
            </div>
          </div>
        <% end %>
        <table class="w-100 table table-bordered dt-responsive datatable wrap-whitespace" data-fixed-header="false">
          <thead>
          <tr>
            <th class="no-sort">
              <span data-toggle="tooltip" title="Serial Number">Sr.</span>
            </th>
            <th class="no-sort">
              <span>SKU</span>
            </th>
            <th class="no-sort">
              <span data-toggle="tooltip" title="MPN">Mfr</span>
            </th>
            <th class="no-sort">
              <span data-toggle="tooltip" title="Description">Description</span>
            </th>
            <th class="no-sort">
              <span data-toggle="tooltip" title="Make">Make</span>
            </th>
            <th class="no-sort">
              <span data-toggle="tooltip" title="">HSN /SAC Code</span>
            </th>
            <th class="no-sort">
              <span data-toggle="tooltip" title="e">UOM</span>
            </th>
            <th class="no-sort">
              <span data-toggle="tooltip" title="Quantity">Qty</span>
            </th>
            <th class="no-sort">
              <span data-toggle="tooltip" title="Unit Price">Unit Price</span>
            </th>
            <th class="no-sort">
              <span data-toggle="tooltip" title="Subtotal">Subtotal</span>
            </th>
            <th class="no-sort">
              <span data-toggle="tooltip" title="Tax Rate">Tax Rate</span>
            </th>
            <% if @sales_invoice.sales_order.sales_quote.tax_summary.strip == '0' ||
                (@sales_invoice.sales_order.sales_quote.tax_summary.to_s.include? "IGST") %>
              <th class="no-sort">
                <span data-toggle="tooltip" title="Tax Rate">IGST Rate</span>
              </th>
              <th class="no-sort">
                <span data-toggle="tooltip" title="Tax Rate">IGST Amt</span>
              </th>
            <% else %>
            <th class="no-sort">
              <span data-toggle="tooltip" title="Tax Rate">CGST Rate</span>
            </th>
              <th class="no-sort">
                <span data-toggle="tooltip" title="Tax Rate">CGST Amt</span>
              </th>
            <th class="no-sort">
              <span data-toggle="tooltip" title="Tax Rate">SGST Rate</span>
            </th>
              <th class="no-sort">
                <span data-toggle="tooltip" title="Tax Rate">SGST Amt</span>
              </th>
            <% end %>
            <th class="no-sort">
              <span data-toggle="tooltip" title="Tax Rate">Total<br>
              (<%= @sales_invoice.inquiry.currency.name %>)</span>
            </th>

          </tr>
          </thead>
          <tbody>
          <% @sales_invoice.rows.each_with_index do |item, index| %>
            <tr>
              <td>
                <span>#<%= index + 1 %></span>
              </td>
              <td>
                <span><%= item.sku %></span>
              </td>
              <td>
                <span><%= item.mpn %></span>
              </td>
              <td>
                <span><%= item.name  %></span>
              </td>
              <td>
                <span><%= item.brand %></span>
              </td>
              <td>
                <span><%= item.hsn %></span>
              </td>
              <td>
                <span><%= item.uom %></span>
              </td>
              <td>
                <span><%= number_to_currency(item.metadata['qty'], precision: 2, unit: '') %></span>
              </td>
              <td>
                <span><%= format_currency(item.metadata['price'], symbol: nil, precision: 2) %></span>
              </td>
              <td>
                <span><%= format_currency(item.metadata['base_row_total'], precision: 2, symbol: nil) %></span>
              </td>
              <td>
                <span><%= item.tax_rate.round(0) %>%</span>
              </td>
              <% if @sales_invoice.sales_order.sales_quote.tax_summary.strip == '0' ||
                  (@sales_invoice.sales_order.sales_quote.tax_summary.to_s.include? "IGST") %>
              <td>
                <span><%= item.tax_rate.round(0) %>%</span>
              </td>
              <td>
                <span><%= format_currency(item.metadata['base_tax_amount'], precision: 2, symbol: nil) %></span>
              </td>
              <% else %>
              <td>
                <span><%= (item.tax_rate / 2).to_f.round(2) %>%</span>
              </td>
                <td>
                  <span><%= format_currency((item.metadata['base_tax_amount'].to_f / 2), precision: 2, symbol: nil) %></span>
                </td>
                <td>
                  <span><%= (item.tax_rate / 2).to_f.round(2) %>%</span>
                </td>
                <td>
                  <span><%= format_currency((item.metadata['base_tax_amount'].to_f / 2), precision: 2, symbol: nil) %></span>
                </td>
                <%end %>
              <td>
                <span><%= format_currency(item.metadata['base_row_total_incl_tax'], precision: 2, symbol: nil) %></span>
              </td>
            </tr>
          <% end %>
          </tbody>
        </table>

      </div>
      <div class="card-footer">
        <div class=form-row>
          <div class="col-6 col-md-4">
            Products
            <strong class="d-block"><%= @sales_invoice.rows.count %></strong>
          </div>

          <div class="col-6 col-md-4 mt-2 mt-md-0">
            Selling Price (E. tax)
            <strong class="d-block"><%= format_currency((@sales_invoice.metadata['base_tax_amount'].to_f / 2), precision: 2, symbol: nil) %></strong>
          </div>
          <div class="col-6 col-md-4 mt-2 mt-md-0">
            Selling Price (I. tax)
            <strong class="d-block"><%= format_currency((@sales_invoice.metadata['base_grand_total'].to_f), precision: 2, symbol: nil) %></strong>
          </div>
        </div>
      </div>
    </div>

  <% end %>

</div>