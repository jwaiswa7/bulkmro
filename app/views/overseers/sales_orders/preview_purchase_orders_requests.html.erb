<div class="col-lg-12">

  <div class="page-header">
    <h2>PO Requests for Order <%= format_id(@sales_order.order_number) %></h2>
    <p>This will <em>Create purchase order requests</em> and log it under
      <strong><%= current_overseer.full_name %></strong>.</p>
  </div>

  <%= simple_form_for(@sales_order, url: create_purchase_orders_requests_overseers_sales_order_path, method: :POST, :html => {:class => 'needs-validation mt-3', :'novalidate' => '', :'data-parsley-validate' => ''}) do |f| %>
    <%= render 'shared/snippets/form_errors', f: f %>
    <%= f.object.class %>
    <%= f.hidden_field :id %>
    <%= f.hidden_field :order_number %>
    <%= f.hidden_field :inquiry %>
    <%= f.hidden_field :opportunity_type %>
    <%= f.hidden_field :payment_option %>
    <%= f.hidden_field :customer_committed_date %>
    <div class="card mb-2">
      <div class="card-body">
        <!--        <div>-->
        <h6 class="text-uppercase text-black-50 mb-1">Details</h6>
        <div class="form-row">
          <% if @sales_order.present? %>
            <div class="col-4 col-md-2 mb-2">
              <strong class="d-block">Sales Order #</strong>
              <%= format_id(@sales_order.order_number) %>
            </div>
          <% end %>

          <% if @sales_order.inquiry.present? %>
            <div class="col-6 col-md-3 mb-2">
              <strong class="d-block">Inquiry #</strong>
              <%= format_id(@sales_order.inquiry.to_s) %>
            </div>
          <% end %>

          <% if @sales_order.present? %>
            <div class="col-4 col-md-2 mb-2">
              <strong class="d-block">Supplier PO Type</strong>
              <%= @sales_order.opportunity_type %>
            </div>
          <% end %>

          <% if @sales_order.payment_option.present? %>
            <div class="col-5 col-md-2 mb-2">
              <strong class="d-block">Payment Terms</strong>
              <%= @sales_order.payment_option %>
            </div>
          <% end %>

          <% if @sales_order.inquiry.present? %>
            <div class="col-5 col-md-3 mb-2">
              <strong class="d-block">Customer Committed Date</strong>
              <%= @sales_order.inquiry.customer_committed_date %>
            </div>
          <% end %>
        </div>
      </div>
    </div>
    <% if @po_requests.present? %>
      <div class="card">
        <div class="card-body">
          <%= f.simple_fields_for :po_requests, @po_requests.values, wrapper_tag: :div do |po_request| %>
            <div>
              <%= po_request.hidden_field :id %>
              <%= po_request.hidden_field :supplier_id %>
              <%= po_request.hidden_field :inquiry_id %>
              <%= po_request.hidden_field :supplier_committed_date %>
              <%= po_request.hidden_field :attachments %>
              <%= po_request.hidden_field :status %>
              <%= po_request.hidden_field :address_id %>
              <%= po_request.hidden_field :contact_id %>
              <%= po_request.hidden_field :logistics_owner_id %>

              <span class="lead text-black-50 text-small mt-1 mr-1">#<%= (@po_requests.index(po_request.object) || 0) %></span>
              <strong><%= po_request.object.supplier.to_s %>
                : <%= po_request.object.supplier.try(:legacy_email) %></strong>

              <div class="form-row mt-2">
                <% if po_request.object.address.present? %>
                  <div class="col-6 col-md-3 mb-2">
                    <strong class="d-block">ADDRESS</strong>
                    <%= po_request.object.address.to_s %>
                  </div>
                <% end %>
                <% if po_request.object.contact.present? %>
                  <div class="col-2 col-md-1 mb-2">
                    <strong class="d-block">CONTACT</strong>
                    <%= po_request.object.contact.to_s %>
                  </div>
                <% end %>
                <% if po_request.object.logistics_owner.present? %>
                  <div class="col-2 col-md-2 mb-2">
                    <strong class="d-block">LOGISTICS OWNER</strong>
                    <%= po_request.object.logistics_owner.to_s %>
                  </div>
                <% end %>
                <div class="col-2 col-md-1 mb-2">
                  <strong class="d-block">STATUS</strong>
                  <%= po_request.object.status %>
                </div>
                <% if po_request.object.supplier_committed_date.present? %>
                  <div class="col-2 col-md-3 mb-2">
                    <strong class="d-block">SUPPLIER COMMITTED DATE</strong>
                    <%= po_request.object.supplier_committed_date %>

                  </div>
                <% end %>
                <div class="col-2 col-md-2 mb-2">

                  <strong class="d-block">Attachments</strong>
                  <% po_request.object.attachments.each do |attachment| %>
                    <%= attachment.filename if attachment.blob_id.present? %>
                  <% end if po_request.object.attachments.attached? %>
                </div>
              </div>

              <%= po_request.nested_fields_for :rows, po_request.object.rows do |po_request_row| %>
                <%= po_request_row.hidden_field :id %>
                <%= po_request_row.hidden_field :sales_order_row_id %>
                <%= po_request_row.hidden_field :product_id %>
                <%= po_request_row.hidden_field :tax_code_id %>
                <%= po_request_row.hidden_field :tax_rate_id %>
                <%= po_request_row.hidden_field :measurement_unit_id %>
                <%= po_request_row.hidden_field :quantity %>
                <div class="form-row">
                  <div class="col-12 col-md-1">
                    <strong class="d-block"><%= po_request.object.rows.first == po_request_row.object ? "Sr." : '' %></strong>
                    <%= ((po_request.object.rows.index(po_request_row.object) || 0) + 1) %>

                  </div>
                  <div class="col-12 col-md-2">
                    <strong class="d-block"><%= po_request.object.rows.first == po_request_row.object ? "Product" : '' %></strong>
                    <%= po_request_row.object.product.to_s %>
                  </div>
                  <div class="col-12 col-md-1">
                    <strong class="d-block"><%= po_request.object.rows.first == po_request_row.object ? "Make" : '' %></strong>
                    <%= po_request_row.object.product.try(:brand).to_s %>
                  </div>
                  <div class="col-12 col-md-1">
                    <strong class="d-block"><%= po_request.object.rows.first == po_request_row.object ? "HSN" : '' %></strong>
                    <%= po_request_row.object.tax_code %>
                  </div>
                  <div class="col-12 col-md-1">
                    <strong class="d-block"><%= po_request.object.rows.first == po_request_row.object ? "T. rate" : '' %></strong>
                    <%= po_request_row.object.tax_rate.to_s %>
                  </div>
                  <div class="col-12 col-md-1">
                    <strong class="d-block"><%= po_request.object.rows.first == po_request_row.object ? "Qty" : '' %></strong>
                    <%= po_request_row.object.quantity.to_f %>
                  </div>
                  <div class="col-12 col-md-1">
                    <strong class="d-block"><%= po_request.object.rows.first == po_request_row.object ? "UOM" : '' %></strong>
                    <%= po_request_row.object.measurement_unit %>
                  </div>
                  <div class="col-12 col-md-1">
                    <strong class="d-block"><%= po_request.object.rows.first == po_request_row.object ? "UP" : '' %></strong>
                    <%= po_request_row.object.converted_unit_selling_price %>
                  </div>
                  <div class="col-12 col-md-1">
                    <strong class="d-block"><%= po_request.object.rows.first == po_request_row.object ? "TP" : '' %></strong>
                    <%= po_request_row.object.converted_total_selling_price %>
                  </div>
                  <div class="col-12 col-md-1">
                    <strong class="d-block"><%= po_request.object.rows.first == po_request_row.object ? "TT" : '' %></strong>
                    <%= po_request_row.object.converted_total_tax %>
                  </div>
                  <div class="col-12 col-md-1">
                    <strong class="d-block"><%= po_request.object.rows.first == po_request_row.object ? "TP with tax" : '' %></strong>
                    <%= po_request_row.object.converted_total_selling_price_with_tax %>
                  </div>
                  <div class="col-12 col-md-1">
                    <strong class="d-block"><%= po_request.object.rows.first == po_request_row.object ? "Lead Time" : '' %></strong>
                    <% lead_time = (po_request_row.object.sales_order_row.nil?) ? "NA" : po_request_row.object.sales_order_row.sales_quote_row.lead_time_option.to_s %>
                    <%= lead_time %>
                  </div>
                </div>
              <% end %>
              <div class="col-md-3 d-none">
                <%= po_request.add_nested_fields_link :rows, class: 'btn btn-outline-success btn-block mb-2 mb-md-0' do %>
                  <i class="fal fa-plus-circle mr-1"></i>Add a Service product
                <% end %>
              </div>
            </div>
            <hr class="<%= f.object.po_requests.last == po_request.object ? 'd-none' : '' %>"/>
          <% end %>
        </div>
        <div class="card-footer">
          <% if policy(@sales_order).create_purchase_orders_requests? %>
            <%= button_tag(type: "submit", class: "btn btn-warning btn-block") do %>
              <i class="fal fa-pen"></i> Create PO requests
            <% end %>
          <% end %>
        </div>
      </div>
    <% else %>
      <div class="card text-lg-center">
        <div class="card-body">
          All quantities satisfied
        </div>
      </div>
    <% end %>
  <% end %>
</div>